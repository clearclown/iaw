要件定義書: Aether (Infrastructure as Workspace System)

1. 用語定義

IaW (Infrastructure as Workspace): ワークスペース（コードのチェックアウト）とインフラ（コンテナランタイム）のライフサイクルを同期させる概念。

Aether: 本システムの名称。

ajj: 本システムのCLIコマンド。jj (Jujutsu) のスーパーセットとして振る舞う。

Backend: コンテナが実際に稼働する場所（Local Docker, Remote Docker, Kubernetes, DevPod等）。

2. システムアーキテクチャ

Aetherは「Sidecar / Wrapper」アーキテクチャを採用する。

graph TD
    User[User / AI Agent] -->|1. Command| CLI[Aether CLI (ajj)]
    CLI -->|2. Delegate VCS Ops| JJ[Jujutsu Binary]
    CLI -->|3. Manage Lifecycle| Provisioner[Resource Provisioner]
    
    subgraph "Execution Plane"
        Provisioner -->|Spawn| Docker[Docker Engine]
        Provisioner -->|Spawn| K8s[Kubernetes Cluster]
    end

    Provisioner -->|4. Inject Config| EnvFile[.env / Config]
    JJ -->|File Ops| Workspace[File System]


3. 機能要件

3.1 ワークスペース管理 (Workspace Lifecycle)

ajj workspace add <destination>

VCS操作: 内部的に jj workspace add <destination> を呼び出し、ディレクトリを作成する。

環境プロビジョニング:

指定されたバックエンドに対し、一意なIDを持つ隔離環境の立ち上げを要求する。

必要に応じて docker compose up や kubectl apply 相当の処理を行う。

動的ポートマッピング (Dynamic Port Mapping):

ホスト側の空いているポートを動的に検索・確保する。

コンテナ側の固定ポート（例: 5432）を、ホスト側の動的ポート（例: 32768）にバインドする。

コンテキスト注入 (Context Injection):

確保した接続情報を、ワークスペースルートの .env ファイル等に書き込む。

AIエージェント向けに、起動情報をJSONで標準出力するオプションを持つ。

ajj workspace forget <workspace> / cleanup

VCS操作: jj workspace forget を呼び出す。

環境破棄: 該当ワークスペースに紐づくコンテナ、ボリューム、ネットワークリソースを即座にかつ完全に削除する（GC）。

3.2 実行・透過的プロキシ (Transparent Execution)

ajj run -- <command>

ワークスペース固有の環境変数をロードした状態で、任意のコマンドを実行する。

リモートバックエンドを使用している場合、コマンド実行中のみ SSHトンネル / Port Forwarding を確立し、localhost へのアクセスをリモートへ転送する機能を提供する。

3.3 バックエンド抽象化

システムは以下のバックエンドをプラグイン可能な形式でサポートする。

Local Docker (MVP): ローカルのDocker Daemonを使用。リソース分離はポートベースで行う。

Remote Docker via SSH: 強力な別サーバー上のDockerを使用。

Kubernetes Namespace: クラスタ上にNamespaceを作成して分離（将来的な拡張）。

4. 非機能要件

AI-First UX:

エラーメッセージは「人間が読んでわかる」だけでなく、「AIが原因を特定し修正できる」構造化された情報を含める。

対話モードよりも、引数による完全制御を優先する。

Performance:

workspace add のオーバーヘッドは、コンテナ起動時間を除き 1秒以内であること。

jj のネイティブな高速性を損なわないこと。

Transparency:

ユーザーはバックエンドがローカルかリモートかを意識せず、常に localhost 感覚で開発できること。

5. インターフェース仕様 (CLI Design)

基本コマンド

# 新規ワークスペース作成（環境構築含む）
ajj workspace add ../feature-a

# 環境変数をロードしてテスト実行
ajj run -- cargo test

# 状態確認（コンテナ情報含む）
ajj status --json


AIエージェント向け出力仕様 (JSON)

{
  "workspace_root": "/path/to/feature-a",
  "backend": "docker-remote",
  "resources": {
    "db": {
      "internal_port": 5432,
      "external_port": 49152,
      "host": "127.0.0.1",
      "connection_string": "postgres://user:pass@127.0.0.1:49152/db"
    }
  }
}
